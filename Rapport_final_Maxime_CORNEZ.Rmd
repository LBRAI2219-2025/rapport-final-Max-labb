---
title: "LBRAI2219 - Modélisation des systèmes biologiques"
author: "Maxime CORNEZ"
date: "24/05/2024"
output:
  html_document:
    smart: false
    code_folding: show
    fig_height: 5
    fig_width: 6
    highlight: tango
    theme: united
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float: true
  pdf_document:
    toc: true
    number_sections: true
    latex_engine: xelatex
    keep_tex: true
bibliography: ressources/LBRAI2219.bib
subtitle: Modèle APSIM pour deux cultures
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Résumé

> Résumé du travail, reprenant les résultats principaux et les perspectives.

# Introduction

## État de l'art

L'agriculture moderne est soumise à de nombreux défis à l'heure actuelle : elle se doit de produire assez pour nourrir la population mondiale, tout en respectant au mieux l'environnement et en s'adaptant aux changements climatiques. Or, les terres disponibles pour l'agriculture ne sont pas illimitées et la pression sur les ressources naturelles est de plus en plus forte. De plus, les ressources en eau et en terre ne sont pas distribuées de manière égale sur la planète, ce qui rend la tâche encore plus complexe [@dudgeon_freshwater_2006].\
L'agriculture dépend de ces deux ressources presque autant qu'elle dépend du soleil, or avec l'augmentation de la population mondiale et les changements climatiques, la disponibilité de l'eau et des terres agricoles est mise à rude épreuve.\
Aujourd'hui, si on combine les terres arables et les prairies,ces deux biomes sont les plus présent à la surface de la Terre, occupant environ 40 % de la surface terrestre. En outre, les terres agricoles sont souvent utilisées de manière intensive, avec des pratiques telles que la monoculture, l'utilisation excessive d'engrais et de pesticides, et la déforestation pour créer de nouvelles terres agricoles. Ces pratiques ont des conséquences néfastes sur l'environnement, notamment la perte de biodiversité, la dégradation des sols et la pollution de l'eau [@foley_global_2005].

\
La recherche agronomique s'est orientée vers des pratiques agricoles plus durables, telles que l'agroécologie, l'agriculture de conservation et la permaculture. Ces pratiques visent à réduire l'impact environnemental de l'agriculture tout en maintenant des rendements élevés. Elles reposent sur une meilleure compréhension des interactions entre les plantes, les sols et les écosystèmes, ainsi que sur l'utilisation de techniques de gestion intégrée des cultures [@bondeau_modelling_2007].

Pour s’adapter aux épisodes de stress hydrique et thermique, les plantes déploient un éventail de réponses physiologiques coordonnées. D’une part, elles ferment partiellement, voire totalement, leurs stomates pour réduire les pertes d’eau, ajustent leur croissance, celle de leurs racines et celle de leur feuillage, pour limiter l’évapotranspiration et modifient l’orientation et la taille de leurs feuilles afin d’optimiser la capture de la lumière sans souffrir de surchauffe. D’autre part, elles optimisent l’efficacité de leur utilisation de l’eau par des ajustements biochimiques, comme l’accumulation d’osmolytes, et par des modifications de la composition de leur cuticule pour diminuer la perte d’eau.\
Au cœur de ces stratégies, l’architecture racinaire joue un rôle décisif. Un enracinement profond permet d’accéder aux réserves hydriques des horizons profonds, tandis qu’une croissance rapide des racines favorise une exploration efficace du volume de sol. La capacité à répartir finement les racines dans les différents niveaux du sol accroît considérablement les probabilités de rencontrer des poches d’humidité. De plus, certaines plantes développent une plasticité racinaire importante, ajustant dynamiquement la ramification et l’élongation des racines selon la disponibilité locale de l’eau, et renforcent leurs interactions avec les champignons mycorhiziens pour améliorer l’absorption hydrique et minérale. Ces traits racinaires combinés forment un arsenal adaptatif essentiel pour maintenir la croissance et la productivité en conditions de déficit hydrique[@munns_comparative_2002].

\
Ce projet traitera plus spécifiquement de la permaculture et des intercultures, techniques visant à maximiser l'espace disponible et les ressources pour deux cultures ou plus occupant le même espace. Ces techniques sont de plus en plus populaires dans les systèmes agricoles durables, car elles permettent de diversifier les cultures, d'améliorer la santé des sols et de réduire les besoins en intrants chimiques [@brooker_improving_2015].

Le maïs (*Zea mays L.*) est l’une des céréales les plus cultivées au monde, environ 850 millions de tonnes produites par an sur approximativement 162 millions d’hectares [@yara_panorama_2018]. Son métabolisme en C₄ lui garantit une photosynthèse très efficace et une bonne tolérance aux fortes températures. Toutefois, il reste fortement dépendant de l’eau, en particulier durant la floraison et la pollinisation, lorsque le stress hydrique peut provoquer des pertes de rendement importantes. Son réseau racinaire dense et profond, pouvant aller jusqu'à 1m80, lui permet une captation efficace de l'eau et des nutriments [@barnabas_effect_2008].

Il serait intéressant d'optimiser ces surfaces de culture en alliant les plants de maïs avec d'autres plantes pouvant bénéficier de cet espace. La sélection des bonnes variétés de plante entrainera un symbiose, améliorant le rendement globale de production et permettant ainsi une meilleure valorisation de l'eau et des ressources.\
Les cultures le plus souvent associées au maïs sont souvent des espèces de petite taille, profitant de l'ombrage apporté par les feuilles du maïs ou de la structure de sa tige[@brooker_improving_2015; @dong_maize_2022; @nassary_productivity_2020; @zhang_using_2003]. On retrouve par exemple :

-   des légumineuses comme les haricots (*Phaseolus vulgaris*) : ils fixent l'azote atmosphérique dans le sol, améliorant ainsi la fertilité du sol et réduisant le besoin en engrais azotés pour le maïs et se servent des tiges de maïs comme support pour leurs tiges [@mudare_yield_2022].

-   des courges (*Cucurbita pepo*) : elles ont de grandes feuilles qui fournissent de l'ombre au sol, réduisant l'évaporation de l'eau et maintenant une température du sol plus fraîche, ce qui est bénéfique pour le maïs. Elles aident également à contrôler les mauvaises herbes en couvrant le sol [@cryan_yield_2025].

-   des salades (*Lactuca sativa*) : elles ont une croissance rapide et peuvent être récoltées avant que le maïs ne devienne trop grand, permettant ainsi une utilisation efficace de l'espace. Elles protègent le sol et exploitent la strate inférieure [@brennan_agronomic_2013].

## Importance de l’approche par modélisation

Comme l'a dit Samuel P. Huntington "Nous avons besoin de modèles explicites ou implicites pour pouvoir ordonner et généraliser la réalité, comprendre les relations causales entre les phénomènes, anticiper et, si nous avons de la chance, prédire les développements futurs, distinguer l’essentiel de l’accessoire et nous indiquer les chemins à suivre pour atteindre nos objectifs". Un modèle n'est jamais une parfaite représentation de la réalité, mais il permet de simplifier et d'organiser les connaissances pour mieux comprendre les systèmes complexes. En agronomie, la modélisation est un outil essentiel pour simuler le comportement des cultures et des systèmes agricoles, en tenant compte des interactions entre les plantes, le sol et l'environnement, sans devoir nécessairement passer par une étape expérimentale longue et coûteuse [@tremblay_comparison_2004].

Le modèle APSIM (pour Agricultural Production Systems sIMulator) est un modèle de simulation de culture qui permet de simuler la croissance des cultures, la dynamique du sol et les interactions entre les plantes et l'environnement. Il a été développé en 1995 par une équipe multiuniversitaire et est encore utilisé et amélioré à ce jour. APSIM est un modèle modulaire, ce qui signifie qu'il peut être adapté à différents systèmes agricoles et à différentes conditions environnementales. Il est capable de simuler la croissance des cultures en tenant compte des facteurs climatiques, hydriques et nutritionnels, ainsi que des interactions entre les plantes et le sol [@mccown_apsim_1996; @keating_overview_2003].\

# Matériel et méthodes

## Modèles

L’étude repose sur une modélisation d'APSIM en combinant deux cultures (maïs et autre) en interculture. Le modèle APSIM est utilisé pour simuler la croissance des cultures, la dynamique du sol et les interactions entre les plantes et l'environnement.

-   **APSIM mono** : Ce modèle a pour but de simuler la production de biomasse chez le maïs en prenant en compte à la fois les contraintes hydriques et lumineuses. Il s’appuie d’une part sur les équations de Monteith, qui relient la croissance à la quantité de rayonnement intercepté, et d’autre part sur le concept d’efficience de transpiration, qui traduit la conversion de l’eau prélevée en biomassе sous stress hydrique. Ensemble, ces deux approches permettent de quantifier l’impact combiné de la lumière et de la disponibilité en eau sur le développement de la culture. [@draye_practical, @hammer_computer_2009]\
    La version présentée ici a été légèrement remise en forme par Alice Falzon et moi-même afin d'en améliorer l'érgonomie et la facilité d'utilisation.

-   **APSIM duo** : Ce modèle est une extension du modèle mono, qui permet de simuler la production de biomasse pour deux cultures en interculture. Il prend en compte les interactions entre les deux cultures pour l'eau et la profondeur des racines. Le modèle est capable de simuler la croissance des deux cultures en tenant compte des facteurs climatiques et hydriques, ainsi que des interactions entre les plantes et le sol. Le modèle inclut un "arbitre" déterminant quelle culture recevra prioritairement l'eau en cas de déficit hydrique, cet arbitre est inclu directement dans la fonction du modèle.\
    Par simplicité, l'hypothèse que les deux cultures n'ont pas d'intéractions au niveau de la lumière a été faite, ce qui signifie que la lumière est répartie entre les deux cultures selon la disponibilité.\
    La conversion de APSIM mono vers duo a représenté la plus grande partie de ce projet.

Le plan de modélisation est structuré comme suit :

1.  Obtention des paramètres de cultures pour chaque culture désirée. Puis des paramètres du sol et de l'expansion foliaire

2.  Obtention des paramètres météo, soit via un jeu de données généré artificiellement, soit via un jeu de données réelles obtenu via Open-Meteo [@open-meteo_2025] ; sélection de la source via le switch installé dans le code.

3.  Fixation des densités de culture.

4.  Simulation de la production de biomasse avec APSIM.

    1.  Pour le maïs seul avec Apsim mono.

    2.  En combinant le maïs avec une autre culture avec Apsim duo.

5.  Analyse et comparaison des résultats.

## Packages

-   **Importation et manipulation de données**

    -   *readxl* : permet de lire directement des fichiers Excel (.xls, .xlsx) en important les feuilles de calcul sous forme de data frames.

    -   *dplyr* et *tidyr* : offrent un ensemble de fonctions (p. ex. filter(), select(), mutate() ) pour nettoyer, transformer et reformater les données de façon claire et fluide.

-   **Visualisation**

    -   *ggplot2* : propose un système de grammaire graphique puissant pour créer des graphiques élégants et personnalisables (histogrammes, nuages de points, séries temporelles, etc.) à partir de de data frames.

-   **Accès et traitement de données web**

    -   *httr* : facilite les requêtes HTTP (GET, POST, authentification) pour interagir avec des API ou récupérer des ressources distantes.

    -   *jsonlite* : convertit des fichiers JSON en objets R (et inversement), ce qui rend l’exploitation des réponses d’API et le stockage des données JSON plus accessibles.

```{r package-setup, include=TRUE, message=FALSE, warning=FALSE}
# Packages requis
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(jsonlite)
library(httr)
```

## Données d'entrée

### Paramètres des cultures

Dans la mesure du possible, les paramètres ont été extraits de la littérature. Lorsque certaines données faisaient défaut, des extrapolations ont été réalisées à partir des connaissances acquises au cours de ma formation, dans un but de différenciation de l'espèce par rapport au maïs. Seules les données relatives au maïs peuvent être considérées comme pleinement fiables, puisqu’elles proviennent d'un exercice pratique donné par le professeur Draye [@draye_practical_nodate , @lin_effects_2013, @ghavidel_evaluation_2016, @ogindo_determination_2004, @rouphael_radiation_2005].

```{r paramètres de culture, include=TRUE}

mais <- list(
  RUE               = 1.6,   # Radiation Use Efficiency [g/MJ]
  TEc               = 9,     # Coefficient d'efficience de la transpiration [Pa]
  VPR               = 20,    # Vitesse production de racines [mm/jour]
  CroissPotLAI      = 0.1,   # Croissance potentielle du LAI 
  k                 = 0.45,  # Coefficient d'extinction de la lumière
  LAI_initial       = 1.5,   
  Biomasse_initiale = 45     
)

sorgho <- list(
  RUE               = 1.25,  # Radiation Use Efficiency [g/MJ]
  TEc               = 9,     # Coefficient d'efficience de la transpiration [Pa]
  VPR               = 20,    # Vitesse production de racines [mm/jour]
  CroissPotLAI      = 0.1,   # Croissance potentielle du LAI 
  k                 = 0.45,  # Coefficient d'extinction de la lumière
  LAI_initial       = 1.5,   
  Biomasse_initiale = 45     
)

haricot <- list(
  RUE               = 1.78,  # Radiation Use Efficiency [g/MJ]
  TEc               = 4.9,   # Coefficient d'efficience de la transpiration [Pa]
  VPR               = 13.5,  # Vitesse production de racines [mm/jour]
  CroissPotLAI      = 0.1,   # Croissance potentielle du LAI 
  k                 = 0.6,   # Coefficient d'extinction de la lumière
  LAI_initial       = 1.0,   
  Biomasse_initiale = 20     
)

courge <- list(
  RUE               = 4.1,   # Radiation Use Efficiency [g/MJ]
  TEc               = 2.9,   # Coefficient d'efficience de la transpiration [Pa]
  VPR               = 15,    # Vitesse production de racines [mm/jour]
  CroissPotLAI      = 0.12,  # Croissance potentielle du LAI 
  k                 = 0.72,  # Coefficient d'extinction de la lumière
  LAI_initial       = 0.8,   
  Biomasse_initiale = 35
)


salade <- list(
  RUE               = 1.2,   # Radiation Use Efficiency [g/MJ]
  TEc               = 3,     # Coefficient d'efficience de la transpiration [Pa]
  VPR               = 8,     # Vitesse production de racines [mm/jour]
  CroissPotLAI      = 0.15,  # Croissance potentielle du LAI 
  k                 = 0.5,   # Coefficient d'extinction de la lumière
  LAI_initial       = 0.6,   
  Biomasse_initiale = 15     
)
```

### Paramètres du sol

Paramètres générés artificiellement pour avoir un sol d' 1m d'épaisseur contenant un minimum de 40mm d'eau et un maximum de 100mm d'eau.\
L'hyphothèse que le kl est une valeur propre au sol a été posée pour simplifier les calculs. En réalité, le kl est variable selon de nombreux critères propres au sol et aux plantes occupant le sol.

```{r paramètres du sol, include=TRUE}

soil_params <- data.frame(
  Horizon     = c(1, 2, 3),
  Epaisseur   = c(300, 300, 400),   # mm
  li          = c(40,  40,  40),    # Limite inférieure d'eau
  ls          = c(100, 100, 100),   # Limite supérieure d'eau
  es          = c(100, 100, 100),   # Eau disponible dans sol (= sw)
  es_h        = c(40, 30, 30),      # Eau disponible dans sol par horizon ; es_h1+es_h2+es_h3 = es
  kl          = c(0.06, 0.05, 0.05) # Taux d'extraction [mm/jour]
)
```

### Expansion foliaire

```{r expansion foliaire, include=TRUE}
# Culture 1
expansion_foliaire <- data.frame(
  OD  = c(0.5, 1.5, 4), # Offre sur demande
  CEF = c(0,   1,   1)  # Coefficient d'expansion foliaire
)

# Culture 2
expansion_foliaire2 <- data.frame(
  OD  = c(0.4, 1.0, 3.5), # Offre sur demande
  CEF = c(0,   0.8, 1)    # Coefficient d'expansion foliaire

)
```

### Paramètres météo

```{r chargement des données météo, include=TRUE, message=FALSE, warning=FALSE}

# Données météo réelles 
lat <- 50.666265; lon <- 4.622322   # Localisation de la zone d'étude : 50.666265 ; 4.622322 = batiment De serres
start_date <- "2024-06-01"; end_date <- "2024-06-30"           # Période de simulation
res <- GET("https://archive-api.open-meteo.com/v1/archive",    # Obtention des données de la station météo belge
           query = list(latitude = lat, longitude = lon,
                        start_date = start_date, end_date = end_date,
                        daily = "temperature_2m_max,temperature_2m_min,shortwave_radiation_sum",
                        timezone = "Europe/Brussels"))
meteo_data <- fromJSON(content(res, "text"))$daily             # Importation du fichier de données JSON

meteo_df <- as.data.frame(meteo_data) %>%
  rename(Date = time, Tmax = temperature_2m_max,
         Tmin = temperature_2m_min, Radiation = shortwave_radiation_sum) %>%
  
  mutate(Jours = 1:n(),  # fonctions pour calculer vdp                                    
         svpTmax = 6.1078 * exp(17.269 * Tmax / (237.3 + Tmax)) * 0.10,
         svpTmin = 6.1078 * exp(17.269 * Tmin / (237.3 + Tmin)) * 0.10,
         VPDcalc = 0.75 * (svpTmax - svpTmin) * 10)

# Génération de données artificielles

facteur_externe <- data.frame(
  # Durée de la simulation (jours)
  Jours = 30:60, 
  
  # Radiation (MJ/m2)
  Radiation = c( 
    27, 27, 14, 24, 23, 21, 
    23, 25, 17, 14, 26, 26, 
    10, 26, 30, 27, 27, 29, 
    27, 26, 25, 23, 14, 25, 
    22, 20, 22, 24, 28, 25, 25
  ),
  
  # Tmax (°C)
  Tmax = c( 
    32.3, 31.0, 26.6, 26.0, 26.6, 29.5, 
    30.8, 32.5, 32.3, 25.2, 27.8, 28.2, 
    27.3, 28.6, 28.6, 28.3, 27.6, 31.0, 
    35.0, 34.3, 31.2, 32.7, 29.9, 30.8, 
    31.2, 28.4, 27.7, 31.4, 33.0, 33.2, 32.7
  ),
  
  # Tmin (°C)
  Tmin = c( 
    16.4, 15.8, 15.6, 10.0, 11.7, 13.0, 
    16.5, 13.8, 16.7, 16.7, 15.8, 12.8, 
    17.3, 11.3, 13.7, 13.4, 13.7, 12.2, 
    14.7, 20.4, 15.5, 17.9, 18.4, 16.0, 
    16.1, 18.0, 14.9, 16.0, 16.2, 17.2, 18.3
  ),
  
  # VPDobs (hPa)
  VPDobs = c( 
    19, 17, 16, 14, 12, 15, 
    18, 19, 23, 21, 15, 14, 
    20, 16, 17, 17, 15, 15, 
    16, 17, 18, 21, 22, 17, 
    18, 20, 18, 19, 19, 20, 21
  )
)

# Fonction pour calculer saturated vapour pressure (SVP)
svp <- function(T) { # satured vapour pressure [kPa]
  6.1078 * exp(17.269 * T / (237.3 + T)) * 0.10
}

# Application à Tmax
facteur_externe$svpTmax <- svp(facteur_externe$Tmax) # pression saturante à Tmax

# Application à Tmin
facteur_externe$svpTmin <- svp(facteur_externe$Tmin) # pression saturante à Tmin

VPDfrac <- 0.75 # par défaut on prend 0.75


# Fonction pour calculer VPDcalc
calc_VPDcalc <- function(svpTmax, svpTmin, VPDfrac) {
  VPDfrac * (svpTmax - svpTmin)*10
}

# Ajout de la colonne VPDcalc
facteur_externe$VPDcalc <- calc_VPDcalc(
  svpTmax  = facteur_externe$svpTmax,
  svpTmin  = facteur_externe$svpTmin,
  VPDfrac  = VPDfrac
)

###############################################################################
# Choix de la source de données : "reel" ou "artificiel" (switch)
###############################################################################
data_source <- "artificiel"    # mettre "artificiel" si on veux le jeu généré

if (data_source == "reel") {
  facteur_externe <- meteo_df %>%
    select(Jours, Radiation, Tmax, Tmin, VPDcalc)
} else if (data_source == "artificiel") {
  facteur_externe <- facteur_externe %>%
    select(Jours, Radiation, Tmax, Tmin, VPDcalc)
} else {
  stop("data_source doit être 'reel' ou 'artificiel'")
}
```

### Densité des deux cultures

```{r densité des cultures, include=TRUE}
Densite1 <- 0.5 # Densité de la culture 1 
Densite2 <- 1-Densite1 # Densité de la culture 2 
```

## Modèles utilisés
### APSIM monoculture
```{r Apsim mono, include=TRUE, message=FALSE, warning=FALSE}

# Ce script simule la croissance d'une culture en fonction de l'eau disponible et de la radiation solaire pour une seule culture
###############################################################################
# Modèle
###############################################################################

simulate <- function(facteur_externe, soil_params, culture_params, expansion_foliaire) {
  n_days <- nrow(facteur_externe)
  
  # Vecteurs pour l'eau disponible par horizon
  ES1 <- numeric(n_days)
  ES2 <- numeric(n_days)
  ES3 <- numeric(n_days)
  
  # Initialisation des réserves d'eau pour chaque horizon
  ES1[1] <- soil_params$es_h[1]
  ES2[1] <- soil_params$es_h[2]
  ES3[1] <- soil_params$es_h[3]
  
  # Initialisation de la LAI dynamique
  LAI_dyn <- numeric(n_days)
  LAI_dyn[1] <- culture_params$LAI_initial
  
  # Préparation d'un data frame pour stocker les résultats totaux
  results <- data.frame(
    Jour = facteur_externe$Jours,
    Tot_ES = numeric(n_days),
    Pot_Supply = numeric(n_days),
    Pot_Demand = numeric(n_days),
    Transpiration = numeric(n_days),
    LAI = numeric(n_days),
    I = numeric(n_days),
    Biomasse_1 = numeric(n_days),
    Biomasse_2 = numeric(n_days),
    O_D = numeric(n_days),
    Biomasse_reelle = numeric(n_days),
    Biomasse_cumulee = numeric(n_days)
  )
  results$LAI[1] <- LAI_dyn[1]
  
  # Fonction pour calculer l'effet d'expansion foliaire
  leaf_exp_effect <- function(sdratio, expansion_foliaire) {
    # Si le ratio est en-deçà du premier seuil, on renvoie la première valeur,
    # si au-dessus du dernier, on renvoie la dernière,
    # sinon on effectue une interpolation linéaire.
    if(sdratio <= expansion_foliaire$OD[1]) {
      return(expansion_foliaire$CEF[1])
    } else if (sdratio >= tail(expansion_foliaire$OD,1)) {
      return(tail(expansion_foliaire$CEF,1))
    } else {
      for(j in 1:(nrow(expansion_foliaire)-1)){
        if(sdratio >= expansion_foliaire$OD[j] && sdratio < expansion_foliaire$OD[j+1]){
          return(expansion_foliaire$CEF[j] + 
                   (sdratio - expansion_foliaire$OD[j]) * 
                   (expansion_foliaire$CEF[j+1] - expansion_foliaire$CEF[j]) / 
                   (expansion_foliaire$OD[j+1] - expansion_foliaire$OD[j]))
        }
      }
    }
  }
  
  # Boucle de simulation pour chaque jour
  for (i in 1:n_days) {
    DAS <- facteur_externe$Jours[i]
    # La profondeur racinaire effective est limitée par la somme des épaisseurs
    profondeur_totale <- sum(soil_params$Epaisseur)
    rdepth <- min(DAS * culture_params$VPR, profondeur_totale)
    
    # Calcul des offres potentielles pour chaque horizon
    of1 <- ifelse(rdepth >= soil_params$Epaisseur[1], 1, rdepth / soil_params$Epaisseur[1]) * ES1[i] * soil_params$kl[1]
    of2 <- ifelse(rdepth <= soil_params$Epaisseur[1], 0,
                  ifelse(rdepth > soil_params$Epaisseur[1] + soil_params$Epaisseur[2],
                         1, (rdepth - soil_params$Epaisseur[1]) / soil_params$Epaisseur[2])) * ES2[i] * soil_params$kl[2]
    of3 <- ifelse(rdepth <= (soil_params$Epaisseur[1] + soil_params$Epaisseur[2]), 0, 
                  (rdepth - soil_params$Epaisseur[1] - soil_params$Epaisseur[2]) / soil_params$Epaisseur[3]) * ES3[i] * soil_params$kl[3]
    
    Pot_Supply <- of1 + of2 + of3
    
    # Calcul de l'effet lumineux : LI = 1 - exp(-k * LAI_dyn)
    li <- 1 - exp(-culture_params$k * LAI_dyn[i])
    
    # Calcul de la demande potentielle
    rad <- facteur_externe$Radiation[i]
    VPDcalc <- facteur_externe$VPDcalc[i]
    Pot_Demand <- rad * li * culture_params$RUE * (VPDcalc / 10) / culture_params$TEc
    
    # Transpiration journalière
    transpiration <- min(Pot_Supply, Pot_Demand)
    
    # Stockage des résultats du jour
    results$Tot_ES[i] <- ES1[i] + ES2[i] + ES3[i]
    results$Pot_Supply[i] <- Pot_Supply
    results$Pot_Demand[i] <- Pot_Demand
    results$Transpiration[i] <- transpiration
    results$LAI[i] <- LAI_dyn[i]
    
    # Calcul du ratio offre/demande (si demande > 0)
    sdratio <- if (Pot_Demand > 0) Pot_Supply / Pot_Demand else 0
    # Calcul de l'effet d'expansion foliaire
    leaf_effect <- leaf_exp_effect(sdratio, expansion_foliaire)
    # delta LAI = leaf_effect * CroissPotLAI
    delta_LAI <- leaf_effect * culture_params$CroissPotLAI
    
    # Mise à jour de LAI pour le jour suivant
    if(i < n_days) {
      LAI_dyn[i + 1] <- LAI_dyn[i] + delta_LAI
    }
    
    # Mise à jour des réserves d'eau pour le jour suivant
    if (i < n_days) {
      if(Pot_Supply > 0) {
        ES1[i + 1] <- ES1[i] - (of1 / Pot_Supply) * transpiration
        ES2[i + 1] <- ES2[i] - (of2 / Pot_Supply) * transpiration
        ES3[i + 1] <- ES3[i] - (of3 / Pot_Supply) * transpiration
      } else {
        ES1[i + 1] <- ES1[i]
        ES2[i + 1] <- ES2[i]
        ES3[i + 1] <- ES3[i]
      }
    }
  }
  
  # Calcul des indices et biomasses après simulation
  results$I <- 1 - exp(-culture_params$k * results$LAI)
  results$Biomasse_1 <- (results$Pot_Supply * culture_params$TEc) / (facteur_externe$VPDcalc / 10)
  results$Biomasse_2 <- facteur_externe$Radiation * culture_params$RUE * results$I
  results$O_D <- ifelse(results$Pot_Demand == 0, 0, results$Pot_Supply / results$Pot_Demand)
  results$Biomasse_reelle <- ifelse(results$O_D > 1, results$Biomasse_2, results$Biomasse_1)
  results$Biomasse_cumulee <- culture_params$Biomasse_initiale + cumsum(results$Biomasse_reelle)
  
  return(results)
}
```

```{r Apsim duo, include=TRUE, message=FALSE, warning=FALSE}

###############################################################################
# Modèle
###############################################################################

simulate_two <- function(facteur_externe, soil_params, culture_params, culture2_params, expansion_foliaire, expansion_foliaire2, Densite1, Densite2) {
  n_days <- nrow(facteur_externe)
  
  # Initialisation du sol (réserves d'eau pour chaque horizon)
  ES1 <- numeric(n_days)
  ES2 <- numeric(n_days)
  ES3 <- numeric(n_days)
  ES1[1] <- soil_params$es_h[1]
  ES2[1] <- soil_params$es_h[2]
  ES3[1] <- soil_params$es_h[3]
  
  # Initialisation des profondeurs racinaires
  rdepth <- numeric(n_days)
  rdepth2 <- numeric(n_days)
  
  # Initialisation des LAI dynamiques pour chaque culture
  LAI1 <- numeric(n_days)
  LAI2 <- numeric(n_days)
  LAI1[1] <- culture_params$LAI_initial
  LAI2[1] <- culture2_params$LAI_initial
  
  # Initialisation de la biomasse pour chaque culture
  Biomasse1 <- numeric(n_days)
  Biomasse2 <- numeric(n_days)
  Biomasse1[1] <- culture_params$Biomasse_initiale
  Biomasse2[1] <- culture2_params$Biomasse_initiale
  
  # Initialisation des vecteurs de biomasse cumulée
  Biomasse_cum1 <- numeric(n_days)
  Biomasse_cum2 <- numeric(n_days)
  Biomasse_cum1[1] <- culture_params$Biomasse_initiale
  Biomasse_cum2[1] <- culture2_params$Biomasse_initiale
  
  # Préparation d'un data frame pour stocker les résultats quotidiens
  results <- data.frame(
    Jour = facteur_externe$Jours,
    Tot_ES = numeric(n_days),         # Eau totale dans le sol
    Pot_Supply = numeric(n_days),     # Offre potentielle globale du sol
    Pot_Demand1 = numeric(n_days),    # Demande potentielle culture 1
    Pot_Demand2 = numeric(n_days),    # Demande potentielle culture 2
    sdratio1 = numeric(n_days),       # Offre/Demande culture 1
    sdratio2 = numeric(n_days),       # Offre/Demande culture 2
    Transpiration1 = numeric(n_days), # Transpiration culture 1
    Transpiration2 = numeric(n_days), # Transpiration culture 2
    LAI1 = numeric(n_days),           # LAI culture 1
    LAI2 = numeric(n_days),           # LAI culture 2
    rdepth = numeric(n_days),         # Profondeur racinaire culture 1
    rdepth2 = numeric(n_days),        # Profondeur racinaire culture 2
    Biomasse1 = numeric(n_days),      # Biomasse journalière culture 1
    Biomasse2 = numeric(n_days)       # Biomasse journalière culture 2
  )
  
  results$LAI1[1] <- LAI1[1]            # Initialisation du LAI1
  results$LAI2[1] <- LAI2[1]            # Initialisation du LAI2
  results$Biomasse1[1] <- Biomasse1[1]  # Initialisation de la biomasse journalière culture 1
  results$Biomasse2[1] <- Biomasse2[1]  # Initialisation de la biomasse journalière culture 2
  
  # Fonction pour calculer l'effet d'expansion foliaire (interpolation sur la table OD/CEF)
  leaf_exp_effect <- function(sdratio, expansion_foliaire) {
    if(sdratio <= expansion_foliaire$OD[1]) {
      return(expansion_foliaire$CEF[1])
    } else if (sdratio >= tail(expansion_foliaire$OD,1)) {
      return(tail(expansion_foliaire$CEF,1))
    } else {
      for(j in 1:(nrow(expansion_foliaire)-1)){
        if(sdratio >= expansion_foliaire$OD[j] && sdratio < expansion_foliaire$OD[j+1]){
          return(expansion_foliaire$CEF[j] + 
                   (sdratio - expansion_foliaire$OD[j]) * 
                   (expansion_foliaire$CEF[j+1] - expansion_foliaire$CEF[j]) / 
                   (expansion_foliaire$OD[j+1] - expansion_foliaire$OD[j]))
        }
      }
    }
  }
  
  # Boucle de simulation quotidienne
  for (i in 1:n_days) {
    ## 1) Profondeurs racinaires
    DAS      <- facteur_externe$Jours[i]
    max_root <- sum(soil_params$Epaisseur)
    rdepth   <- min(DAS * culture_params$VPR,  max_root)
    rdepth2  <- min(DAS * culture2_params$VPR, max_root)
    results$rdepth[i]  <- rdepth
    results$rdepth2[i] <- rdepth2
    
    ## 2) Offres potentielles par horizon [1 à 3], par culture [c1 ; c2]
    of1_c1 <- ifelse(rdepth  >= soil_params$Epaisseur[1], 1, rdepth  / soil_params$Epaisseur[1]) * ES1[i] * soil_params$kl[1]
    of2_c1 <- ifelse(rdepth  <= soil_params$Epaisseur[1], 0,
                     ifelse(rdepth > soil_params$Epaisseur[1]+soil_params$Epaisseur[2],
                            1, (rdepth - soil_params$Epaisseur[1]) / soil_params$Epaisseur[2])) * ES2[i] * soil_params$kl[2]
    of3_c1 <- ifelse(rdepth  <= sum(soil_params$Epaisseur[1:2]), 0,
                     (rdepth - sum(soil_params$Epaisseur[1:2])) / soil_params$Epaisseur[3]) * ES3[i] * soil_params$kl[3]
    
    of1_c2 <- ifelse(rdepth2 >= soil_params$Epaisseur[1], 1, rdepth2 / soil_params$Epaisseur[1]) * ES1[i] * soil_params$kl[1]
    of2_c2 <- ifelse(rdepth2 <= soil_params$Epaisseur[1], 0,
                     ifelse(rdepth2 > soil_params$Epaisseur[1]+soil_params$Epaisseur[2],
                            1, (rdepth2 - soil_params$Epaisseur[1]) / soil_params$Epaisseur[2])) * ES2[i] * soil_params$kl[2]
    of3_c2 <- ifelse(rdepth2 <= sum(soil_params$Epaisseur[1:2]), 0,
                     (rdepth2 - sum(soil_params$Epaisseur[1:2])) / soil_params$Epaisseur[3]) * ES3[i] * soil_params$kl[3]
    
    Pot_Supply1 <- of1_c1 + of2_c1 + of3_c1
    Pot_Supply2 <- of1_c2 + of2_c2 + of3_c2
    Pot_Supply  <- Pot_Supply1 + Pot_Supply2  # totale
    
    ## 3) Effet lumineux
    li1 <- 1 - exp(-culture_params$k  * LAI1[i])
    li2 <- 1 - exp(-culture2_params$k * LAI2[i])
    
    results$li1[i] <- li1;  results$li2[i] <- li2
    
    ## 4) Demandes potentielles
    rad    <- facteur_externe$Radiation[i]
    VPDcalc <- facteur_externe$VPDcalc[i]
    Pot_Demand1 <- rad * li1 * culture_params$RUE  * (VPDcalc/10) / culture_params$TEc
    Pot_Demand2 <- rad * li2 * culture2_params$RUE * (VPDcalc/10) / culture2_params$TEc
    
    results$Pot_Demand1[i] <- Pot_Demand1
    results$Pot_Demand2[i] <- Pot_Demand2
    
    ## 5) Transpiration journalière par culture
    TT1     <- min(Pot_Supply1, Pot_Demand1) # Transpiration locale culture 1
    TT2     <- min(Pot_Supply2, Pot_Demand2) # Transpiration locale culture 2
    transp1 <- if (Pot_Demand1 > 0) TT1 * (Pot_Demand1 * Densite1) / (Pot_Demand1 * Densite1 + Pot_Demand2 * Densite2) else 0     #transpiration culture 1 avec arbitrage
    transp2 <- if (Pot_Demand2 > 0) TT2 * (Pot_Demand2 * Densite2) / (Pot_Demand1 * Densite1 + Pot_Demand2 * Densite2) else 0     #transpiration culture 2 avec arbitrage
    
    results$Transpiration1[i] <- TT1
    results$Transpiration2[i] <- TT2
    
    
    # Stockage de l'eau totale du sol
    results$Tot_ES[i] <- ES1[i] + ES2[i] + ES3[i]
    results$Pot_Supply[i] <- Pot_Supply
    
    # Mise à jour des LAI pour chaque culture
    # On calcule le ratio offre/demande pour chaque culture
    sdratio1 <- if (Pot_Demand1 > 0) Pot_Supply1 / Pot_Demand1 else 0 # =O/D culture 1
    sdratio2 <- if (Pot_Demand2 > 0) Pot_Supply2 / Pot_Demand2 else 0 # =O/D culture 2
    leaf_effect1 <- leaf_exp_effect(sdratio1, expansion_foliaire)
    leaf_effect2 <- leaf_exp_effect(sdratio2, expansion_foliaire2)
    delta_LAI1 <- leaf_effect1 * culture_params$CroissPotLAI
    delta_LAI2 <- leaf_effect2 * culture2_params$CroissPotLAI
    
    # Mise à jour du LAI pour chaque culture
    if(i < n_days) {
      LAI1[i + 1] <- LAI1[i] + delta_LAI1
      LAI2[i + 1] <- LAI2[i] + delta_LAI2
    }
    
    # Mise à jour des résultats
    results$sdratio1[i] <- sdratio1
    results$sdratio2[i] <- sdratio2
    results$LAI1[i] <- LAI1[i]
    results$LAI2[i] <- LAI2[i]
    
    # Mise à jour de la biomasse pour chaque culture
    # Calcul de la biomasse journalière pour chaque culture
    Biomasse_calc1 <- if (sdratio1 > 1) rad * li1 * culture_params$RUE else transp1 * (culture_params$TEc / (VPDcalc/10))
    Biomasse_calc2 <- if (sdratio2 > 1) rad * li2 * culture2_params$RUE else transp2 * (culture2_params$TEc / (VPDcalc/10))
    
    # Mise à jour de la biomasse cumulée pour chaque culture
    if(i < n_days) {
      Biomasse_cum1[i + 1] <- Biomasse_cum1[i] + Biomasse_calc1
      Biomasse_cum2[i + 1] <- Biomasse_cum2[i] + Biomasse_calc2
    }
    results$Biomasse1[i] <- Biomasse_calc1
    results$Biomasse2[i] <- Biomasse_calc2
    results$Biomasse_cum1[i] <- Biomasse_cum1[i]
    results$Biomasse_cum2[i] <- Biomasse_cum2[i]
    
    ## 9) Mise à jour des ES horizon par horizon
    if (i < n_days) {
      if (Pot_Supply1 + Pot_Supply2 > 0) {
        ES1[i+1] <- ES1[i] - ((of1_c1 / Pot_Supply1) * transp1 + (of1_c2 / Pot_Supply2) * transp2)
        ES2[i+1] <- ES2[i] - ((of2_c1 / Pot_Supply1) * transp1 + (of2_c2 / Pot_Supply2) * transp2)
        ES3[i+1] <- ES3[i] - ((of3_c1 / Pot_Supply1) * transp1 + (of3_c2 / Pot_Supply2) * transp2)
      } 
      else {
        ES1[i+1] <- ES1[i]
        ES2[i+1] <- ES2[i]
        ES3[i+1] <- ES3[i]
      }
    }
  }  
  
  return(results)
}
```

# Résultats

## Simulation des cultures

```{r simulation, include=TRUE, message=FALSE, warning=FALSE}
resultat_mais <- simulate(facteur_externe, soil_params, mais, expansion_foliaire) # simulation maïs seul
#print(resultat_mais)
resultat_mais$Pot_Supply >= resultat_mais$Transpiration


resultats_mais_haricot <- simulate_two(facteur_externe, soil_params, mais, haricot, expansion_foliaire, expansion_foliaire2, Densite1, Densite2) # simulation maïs + haricot
#print(resultats_mais_haricot)
resultats_mais_haricot$Pot_Supply >= resultats_mais_haricot$Transpiration1 + resultats_mais_haricot$Transpiration2

resultats_mais_courge <- simulate_two(facteur_externe, soil_params, mais, courge, expansion_foliaire, expansion_foliaire2, Densite1, Densite2) # simulation maïs + courge
#print(resultats_mais_courge)
resultats_mais_courge$Pot_Supply >= resultats_mais_courge$Transpiration1 + resultats_mais_courge$Transpiration2

resultats_mais_salade <- simulate_two(facteur_externe, soil_params, mais, salade, expansion_foliaire, expansion_foliaire2, Densite1, Densite2) # simulation maïs + salade
#print(resultats_mais_salade)
resultats_mais_salade$Pot_Supply >= resultats_mais_salade$Transpiration1 + resultats_mais_salade$Transpiration2

```

## Modélisation de l’évolution de la culture (bah oui)

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

## Couplage entre le modèle racinaire et le modèle de culture (remplacer par couplage de 2 cultures)

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

## Analyse de l’interaction entre rendements et racines (kl ?)

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

# Collaboration

Lors de ce projet j'ai eu l'occasion de collaborer avec plusieurs collègues autant pour améliorer mon projet que pour les aider avec le leur.

Je tiens à remercier tout particulièrement Alice Falzon avec qui j'ai travaillé à l'élaboration du modèle APSIM_2025, qui est la base de ce projet, elle m'a aussi fourni le code pour obtenir les données météo réelles via Open-Meteo et pour ses retours concernant mon rapport.\
En retour j'ai pu l'aider à améliorer quelques points de son modèle et j'ai aussi relu son rapport.

Nous avons partagé notre code avec le reste de la classe, mais je ne saurais dire précisément qui l'a utilisé.

Je remercie aussi Ismael Peeters pour son aide sur la théorie lié au kl.

J'ai pu aidé Emile Davio et Zoé Saintrain sur des points relatifs à la théorie et au code d'APSIM.

# Références
